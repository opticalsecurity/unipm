# .github/workflows/ci.yaml
# Unified CI/CD Pipeline for unipm
#
# Workflow triggers:
#   - Pull Requests: Test + Lint + Build artifacts (prerelease)
#   - Push to master/dev: Test + Lint + Build artifacts
#   - Version bump on master: Full release with GitHub Release creation
#
# Developer experience priorities:
#   - Fast feedback on PRs (parallel jobs)
#   - Automatic release drafts updated on every merge
#   - Single source of truth for build matrix

name: CI

on:
  push:
    branches: [master, dev]
  pull_request:
    branches: [master, dev]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: "latest"

jobs:
  # ============================================
  # Quality Gate: Test & Lint
  # ============================================
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run tests with coverage
        run: bun run test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 14

  # ============================================
  # Build Matrix: Cross-platform binaries
  # ============================================
  build:
    name: Build (${{ matrix.target }})
    needs: test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - bun-linux-x64
          - bun-linux-arm64
          - bun-darwin-x64
          - bun-darwin-arm64
          - bun-windows-x64
          - bun-linux-x64-musl
          - bun-linux-arm64-musl
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build for ${{ matrix.target }}
        run: bun run build --target ${{ matrix.target }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: unipm-${{ matrix.target }}
          path: ./out/*
          retention-days: 30

  # ============================================
  # Release Check: Detect version changes
  # ============================================
  check-release:
    name: Check Release
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.version.outputs.changed }}
      version: ${{ steps.version.outputs.version }}
      previous_version: ${{ steps.version.outputs.previous_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check version change
        id: version
        run: |
          CURRENT=$(jq -r '.version' package.json)
          git checkout HEAD~1 -- package.json 2>/dev/null || echo '{"version":"0.0.0"}' > package.json.prev
          if [ -f package.json.prev ]; then
            PREVIOUS=$(jq -r '.version' package.json.prev)
          else
            PREVIOUS=$(jq -r '.version' package.json)
          fi
          git checkout HEAD -- package.json
          
          echo "version=$CURRENT" >> $GITHUB_OUTPUT
          echo "previous_version=$PREVIOUS" >> $GITHUB_OUTPUT
          
          if [ "$CURRENT" != "$PREVIOUS" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üì¶ Version changed: $PREVIOUS ‚Üí $CURRENT"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Version unchanged: $CURRENT"
          fi

  # ============================================
  # Release: Create GitHub Release with assets
  # ============================================
  release:
    name: Release
    needs: [build, check-release]
    if: needs.check-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: unipm-*

      - name: Build .deb packages
        run: |
          VERSION="${{ needs.check-release.outputs.version }}"
          
          # Build .deb for each Linux architecture
          for arch_pair in "x64:amd64" "arm64:arm64"; do
            BUN_ARCH="${arch_pair%%:*}"
            DEB_ARCH="${arch_pair##*:}"
            BINARY_NAME="unipm-linux-${BUN_ARCH}"
            DEB_NAME="unipm_${VERSION}_${DEB_ARCH}"
            
            # Find the binary
            BINARY_PATH=$(find artifacts -name "*linux*${BUN_ARCH}*" -not -name "*musl*" -type f | head -1)
            
            if [ -z "$BINARY_PATH" ]; then
              echo "‚ö†Ô∏è Binary not found for ${BUN_ARCH}, skipping .deb"
              continue
            fi
            
            echo "üì¶ Building .deb for ${DEB_ARCH} from ${BINARY_PATH}"
            
            # Create directory structure
            mkdir -p "${DEB_NAME}/DEBIAN"
            mkdir -p "${DEB_NAME}/usr/bin"
            
            # Copy binary
            cp "$BINARY_PATH" "${DEB_NAME}/usr/bin/unipm"
            chmod 755 "${DEB_NAME}/usr/bin/unipm"
            
            # Create control file
            cat > "${DEB_NAME}/DEBIAN/control" << EOF
          Package: unipm
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: ${DEB_ARCH}
          Maintainer: Manuel Nicastro <manuel@nicast.ro>
          Description: Universal package manager CLI
           unipm is a universal package manager CLI that auto-detects and
           delegates to the appropriate Node.js package manager (npm, pnpm, yarn, bun).
          Homepage: https://github.com/${{ github.repository }}
          EOF
            
            # Build .deb package
            dpkg-deb --build "${DEB_NAME}"
            
            # Move to artifacts for later processing
            mkdir -p "artifacts/unipm-deb-${DEB_ARCH}"
            mv "${DEB_NAME}.deb" "artifacts/unipm-deb-${DEB_ARCH}/"
            
            echo "‚úÖ Created ${DEB_NAME}.deb"
          done

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          for dir in artifacts/unipm-*/; do
            if [ -d "$dir" ]; then
              for file in "$dir"*; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  # Add .exe extension for Windows binaries if not present
                  if [[ "$filename" == *"windows"* ]] && [[ ! "$filename" == *.exe ]]; then
                    cp "$file" "release-assets/${filename}.exe"
                  else
                    cp "$file" "release-assets/$filename"
                  fi
                fi
              done
            fi
          done
          
          echo "üì¶ Release assets prepared:"
          ls -la release-assets/

      - name: Generate checksums
        working-directory: release-assets
        run: |
          # Generate individual .sha256 files for each binary (for installers/updaters)
          for file in *; do
            if [ -f "$file" ] && [[ ! "$file" == *.sha256 ]] && [[ ! "$file" == checksums.txt ]]; then
              sha256sum "$file" > "${file}.sha256"
              echo "Generated: ${file}.sha256"
            fi
          done
          
          # Also generate combined checksums.txt for manual verification
          sha256sum * 2>/dev/null | grep -v '.sha256' > checksums.txt || true
          echo "üîê Checksums generated:"
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-release.outputs.version }}
          name: unipm v${{ needs.check-release.outputs.version }}
          body: |
            ## unipm v${{ needs.check-release.outputs.version }}
            
            ### üì¶ Quick Install
            
            **Linux / macOS:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/master/scripts/install.sh | bash
            ```
            
            **Windows (PowerShell):**
            ```powershell
            irm https://raw.githubusercontent.com/${{ github.repository }}/master/scripts/install.ps1 | iex
            ```
            
            ### üì• Manual Download
            
            | Platform | Architecture | File |
            |----------|--------------|------|
            | Linux | x64 | `unipm-linux-x64` |
            | Linux | ARM64 | `unipm-linux-arm64` |
            | Linux (musl) | x64 | `unipm-linux-x64-musl` |
            | Linux (musl) | ARM64 | `unipm-linux-arm64-musl` |
            | Linux (.deb) | x64 | `unipm_${{ needs.check-release.outputs.version }}_amd64.deb` |
            | Linux (.deb) | ARM64 | `unipm_${{ needs.check-release.outputs.version }}_arm64.deb` |
            | macOS | x64 (Intel) | `unipm-darwin-x64` |
            | macOS | ARM64 (Apple Silicon) | `unipm-darwin-arm64` |
            | Windows | x64 | `unipm-windows-x64.exe` |
            
            ### üì¶ Debian/Ubuntu Install
            
            ```bash
            # Download and install (x64)
            curl -LO https://github.com/${{ github.repository }}/releases/download/v${{ needs.check-release.outputs.version }}/unipm_${{ needs.check-release.outputs.version }}_amd64.deb
            sudo dpkg -i unipm_${{ needs.check-release.outputs.version }}_amd64.deb
            ```
            
            ### üîê Verification
            
            Each binary has a corresponding `.sha256` file for verification:
            ```bash
            # Linux/macOS
            sha256sum -c unipm-linux-x64.sha256
            
            # Or verify manually
            cat unipm-linux-x64.sha256
            sha256sum unipm-linux-x64
            ```
            
            ---
            
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ needs.check-release.outputs.previous_version }}...v${{ needs.check-release.outputs.version }}
          draft: false
          prerelease: false
          files: release-assets/*
          generate_release_notes: true

  # ============================================
  # Draft Release: Keep release notes updated
  # ============================================
  draft-release:
    name: Update Release Draft
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - uses: release-drafter/release-drafter@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
